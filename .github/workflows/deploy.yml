name: Deploy Core

on:
  workflow_dispatch:
    inputs:
      rpc_url:
        description: RPC URL to deploy against
        required: true
        type: string
      salt:
        description: CREATE2 salt used for deterministic deployments
        required: false
        default: "0x81385ba264a7f8c1b8208abaa20f59081c2afc5415c2b57c383f951930ff6faa"
        type: string

jobs:
  deploy:
    name: Deploy All
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Show Forge version
        run: |
          forge --version

      - name: Run DeployAll
        run: |
          forge script DeployAll --rpc-url ${{ inputs.rpc_url }} --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY }} --broadcast --verify --retries 50
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          SALT: ${{ inputs.salt }}

      - name: Upload broadcast artifacts
        uses: actions/upload-artifact@v4
        with:
          name: broadcast
          path: broadcast
          retention-days: 90
          if-no-files-found: warn
